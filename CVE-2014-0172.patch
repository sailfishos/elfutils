From 7f1eec317db79627b473c5b149a22a1b20d1f68f Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mjw@redhat.com>
Date: Wed, 9 Apr 2014 11:33:23 +0200
Subject: CVE-2014-0172 Check for overflow before calling malloc to uncompress
 data.

https://bugzilla.redhat.com/show_bug.cgi?id=1085663

Reported-by: Florian Weimer <fweimer@redhat.com>
Signed-off-by: Mark Wielaard <mjw@redhat.com>

Index: elfutils-0.156/libdw/dwarf_begin_elf.c
===================================================================
--- elfutils-0.156.orig/libdw/dwarf_begin_elf.c
+++ elfutils-0.156/libdw/dwarf_begin_elf.c
@@ -289,6 +289,12 @@ check_section (Dwarf *result, GElf_Ehdr
 	    memcpy (&size, data->d_buf + 4, sizeof size);
 	    size = be64toh (size);
 
+	    /* Check for unsigned overflow so malloc always allocated
+	       enough memory for both the Elf_Data header and the
+	       uncompressed section data.  */
+	    if (unlikely (sizeof (Elf_Data) + size < size))
+	      break;
+
 	    Elf_Data *zdata = malloc (sizeof (Elf_Data) + size);
 	    if (unlikely (zdata == NULL))
 	      break;
